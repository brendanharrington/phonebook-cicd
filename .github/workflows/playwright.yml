name: Playwright Tests

on :
  push:
    branches:
      - main
  pull_request:
    branches: [main]
    types: [opened, synchronize]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      MONGODB_URI: mongodb://localhost:27017/phonebook_e2e_test
      PHONEBOOK_API_BASE: http://localhost:5001
      CI: 'true'
    steps:
    - uses: actions/checkout@v5
    - uses: actions/setup-node@v5
      with:
        node-version: '20'
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Start dev server (background)
      run: |
        # Start the dev server in background. Ensure it reads MONGODB_URI from env.
        npm run dev > server.log 2>&1 & echo $! > server.pid
    - name: Wait for server health
      run: |
        echo "Waiting for server health..."
        for i in {1..30}; do
          if curl -sS --fail http://localhost:5001/health || curl -sS --fail http://localhost:5173/; then
            echo "server ok"
            break
          fi
          sleep 1
        done
    - name: Run Playwright tests
      run: npx playwright test --reporter=github
    - name: Upload Playwright report
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
    - name: Upload server log on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: server-log
        path: server.log